<table id="news_data"></table>


<div id="add_news" class="easyui-dialog" title="添加新闻" data-options="iconCls:'icon-add',resizable:true,modal:true,closed:true,fit:true">
<br />
	<form action="" style="float:left;padding-left:20px;">
		<label>新闻编号：</label><font id="nid">未分配</font><br/><br/>
		<label>新闻类型：</label><select id="news_newstype" name="tid" style="width:100px;"></select><br /><br />
		<label>新闻标题：</label><input type="text" id="news_title" name="title" required="required" /><br /><br />
		<label>新闻作者：</label><input type="text" id="news_author" name="author" required="required" /><br /><br />
		<!-- <label>浏览次数：</label><input type="text" id="news_view" name="view" /><br /><br /> -->
		<label>新闻日期：</label><input type="text" id="news_ndate" name="ndate" class="easyui-datebox" required="required" /><br /><br />
		<label>新闻权重：</label><input type="number" id="news_weight" min="0" name="weight" required="required" value="0"/><br /><br />
		<label>新闻图片：</label><input type="file" multiple="multiple" id="news_pics" name="pics" onchange="previewMultipleImage(this,'news_pic_show')" /><br /><br />
		<img id="news_pic" style="display:none;width:50px;" /></br/><br/>
		<label>新闻内容：</label>
		
		<div>
   	 		<script id="editor" type="text/plain" style="width:800px;height:300px;"></script>
		</div>
		
		<a href="javascript:addNewsInfo()" class="easyui-linkbutton" data-options="iconCls:'icon-add'">添加</a>
		<a href="javascript:updateNewsInfo()" class="easyui-linkbutton" data-options="iconCls:'icon-edit'">修改</a>
	</form>
	<div style="float:right;width:300px;margin-right:20px;margin-bottom:20px;">
		<fieldset id="news_pic_show">
			<legend>图片预览</legend>
		</fieldset>
	</div>
</div>
//多条件组合查询
<div id="mul_search"  class="easyui-dialog" style="width:300px; height:300px;" title="多条件查询新闻" data-options="iconCls:'icon-search',resizable:false,modal:true,closed:true">
	<table style="margin:7px;">
		<tr>
			<td style="margin:10px;">新闻类型：</td><td><input  style="margin:10px;" id="newsType" /></td>
		</tr>
		<tr>
			<td style="margin:10px;">新闻标题：</td><td><input  style="margin:10px;" id="newsTitle" /></td>
		</tr>
		<tr>
			<td style="margin:10px;">开始日期：&nbsp;&nbsp;&nbsp;&nbsp;</td><td><input type="text"  id="newsStart" name="newsStart" class="easyui-datebox" /></td>
		</tr>
		<tr>
			<td style="margin:10px;">结束日期：&nbsp;&nbsp;&nbsp;&nbsp;</td><td><input type="text" id="newsEnd" name="newsEnd" class="easyui-datebox" /></td>
		</tr>
	</table>
	<a style="margin:20px 100px;" href="javascript:searchSubmit()" class="easyui-linkbutton" data-options="iconCls:'icon-search'">查找</a>
</div>



<script>
function updateNewsInfo(){
	var tid=$.trim( $("#news_newstype").val() );
	var nid=$.trim( $("#nid").html() );
	var title=$.trim( $("#news_title").val() );
	var author=$.trim( $("#news_author").val() );
	var view=$.trim($("#news_view").val() );
	var ndate=$.trim( $("#news_ndate").datebox('getValue'));
	//alert(ndate);
	var weight=$.trim( $("#news_weight").val() );
	var content=ue.getContent();
	
	//alert(nid);
	$.ajaxFileUpload({
		url:"../../newsServlet?op=updateNewsInfo",
		secureuri:false,
		fileElementId:"news_pics",
		dataType:"json",
		data:{'nid':nid,'tid':tid,'title':title,'author':author,'ndate':ndate,'weight':weight,'content':content},
		success:function(data,status){
			if(data[0].code>0){
				$.messager.show({title:'成功提示',msg:"新闻信息修改成功...",timeout:2000,showType:'slide'});
				$("#news_newstype").val("");
				$("#news_title").val("");
				$("#news_author").val("");
				$("#news_view").val("");
				$("#news_ndate").datebox('setValue',"");
				$("#news_weight").val("0");
				ue.setContent("");
				$("#news_pic_show").html("");
				$('#news_data').datagrid("reload");
				$('#add_news').dialog('close');  
			}else{
				$.messager.alert("错误提示","新闻信息修改失败...\n","error");
			}
		},
		error:function(data,status,e){
			$.messager.alert("错误提示","新闻信息修改失败...\n"+e,"error");
		}
	});
}


//实例化编辑器
//建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
var ue = UE.getEditor('editor');
var obj;
var editRow=undefined;//记录当前正在被编辑的行
var currentOp='findNewsByPage';
var flag;

obj=$('#news_data').datagrid({
	url:'../../newsServlet',
	queryParams:{'op':currentOp},
	fitColumns:true,
	striped:true,
	loadMsg:"数据加载中...",
	pagination:true,
	fit:true,
	pageNumber:1,
	pageSize:10,
	pageList:[10,15,20,25,30],
	remoteSort:false,
	columns:[[
		{field:'tid',title:'',width:100,align:'center',checkbox:true},
		{field:'nid',title:'新闻编号',width:100,align:'center',sortable:true},
		{field:'title',title:'新闻标题',width:100,align:'center'},
		{field:'author',title:'新闻作者',width:100,align:'center'},
		{field:'ndate',title:'发布日期',width:100,align:'center'},
		{field:'tname',title:'新闻类型',width:100,align:'center'},
		{field:'weight',title:'新闻权重',width:100,align:'center',
			formatter:function(value,rowData,index){
				//console.log(rowData);
				var nid=$(rowData).attr("nid");//js对象转换成jquery对象
				str="<a href='javascript:up("+nid+","+index+")'>▲</a>&nbsp;&nbsp;"+"<span>"+value+"</span>"+"&nbsp;&nbsp;<a href='javascript:down("+nid+","+index+")'>▼</a>&nbsp;&nbsp;<a href='javascript:toTop("+nid+","+index+")'>置顶</a>";
				return str;
			}
		},
		{field:'views',title:'浏览次数',width:100,align:'center'},
		{field:'pics',title:'图片',width:100,align:'center',
			formatter:function(value,rowData,index){
				if(value!=null && value!=""){
					var str="";
					var pics=value.split(",");
					for(var i=0;i<pics.length;i++){
						str+=" <img src='../../"+pics[i]+"' width='60px' height='60px'/>&nbsp;";
					}
					return str;
				}else{
					return;
				}
			}
		},
		{field:'content',title:'操作',width:100,align:'center',
			formatter:function(value,rowData,index){
				return "<a href='javascript:showInfo("+$(rowData).attr("nid")+")'>详细</a>";
				//return $(rowData).attr("nid");
			}
		}
	]],
	toolbar:[{
		text:"添加",
		iconCls:"icon-add",
		handler:function(){
			$("#add_news").dialog('open');
			$("#news_ndate").datebox('setValue',myformatter(new Date()));
			$("#nid").html("未分配");
			$("#news_title").val("");
			$("#news_author").val("");
			$("#news_weight").val(0);
			$("#news_pic").css("display","none");
			$("#news_pic").attr("src","");
			ue.setContent("");
		}
	},{
		text:"修改",
		iconCls:"icon-edit",
		handler:function(){
			var rows=obj.datagrid("getChecked")[0];
			//alert(rows);
			if(rows==undefined){
				return;
			}
			$("#add_news").dialog('open');
			//currentOp="updateNews";
			flag="修改";
			rows=$(rows);
			//console.log(rows);
			//alert(rows.attr("ndate"));
			//console.log(rows.attr("ndate"));
			/* alert(rows.attr("tname"));
			$( "news_newstype").val(rows.attr("tname"));*/
			$("#news_title").val(rows.attr("title"));
			$("#news_author").val(rows.attr("author"));
			$("#news_ndate").datebox('setValue',myformatter(new Date(rows.attr("ndate"))));
			$("#news_weight").val(rows.attr("weight"));
			$("#news_pic").css("display","block");
			$("#news_pic").attr("src","../../"+rows.attr("pics"));
			//ue.setContent(rows.attr("content"));
			//alert(rows.attr("nid"));
			$("#nid").html(rows.attr("nid"));
			var nid=rows.attr("nid");
			$.post("../../newsServlet",{op:"getContent",nid:nid},function(data){
				$.each(data.rows,function(index,item){
					ue.setContent(item.content);
				});
			},"json");
			
		}
	},{
		text:'删除',
		iconCls:"icon-remove",
		handler:function(){
		//获取选中的行
			var rows=obj.datagrid("getChecked");
			if(rows!=undefined){
				$.messager.confirm('信息确认', '您真的要删除选中的数据吗?', function(rs){
					if (rs){
						var nids="";
						for(var i=0;i<rows.length;i++){
							nids+=rows[i].nid+",";
						}
						//发请求到数据库
						$.post("../../newsServlet",{op:"delNews",'nids':nids},function(data){
							//如果这里用的是JsonArray传递的，就要data[0]
							//如果这里用的是Gson，就用data就可以   --》这里的data就相当于是jm
							if(data.code=1){
								$.messager.show({title:'成功提示',msg:"终于成功啦",timeout:2000,showType:'slide'});
								rows=null;
								obj.datagrid("reload");//刷新表格
							}else{
								$.messager.show({title:'失败提示',msg:"还是失败啦~~~",timeout:2000,showType:'slide'});
								rows=null;
								obj.datagrid("reload");//刷新表格
							}
						});
					}else{
						return;	
					}
				});
			}else{
				$.messager.show({title:'温馨提示',msg:'请选中您要删除的数据.....',timeout:2000,showType:'slide'});
			}
		}
	},{//新闻类型、新闻标题、开始时间、结束时间   
		text:'多条件组合查询',
		iconCls:"icon-search",	
		handler:function(){
			$("#mul_search").dialog("open");
		}
		
	}]
});

function myformatter(date){
	//alert(date);
	var y=date.getFullYear();
	var m=date.getMonth()+1;
	var d=date.getDate();
	return y+"-"+(m>10?('0'+m):m)+"-"+(d<10?('0'+d):d);
}

$(function(){
	$.post("../../newsTypeServlet",{op:"findAllNewsType"},function(data){
		var obj=$("#news_newstype");
		var opt;
		$.each(data.rows,function(index,item){
			opt="<option value='"+item.tid+"'>"+item.tname+"</option>";
			obj.append($(opt));
		});
	},"json");
});

function addNewsInfo(){
	var tid=$.trim( $("#news_newstype").val() );
	var title=$.trim( $("#news_title").val() );
	var author=$.trim( $("#news_author").val() );
	var ndate=$.trim( $("#news_ndate").datebox('getValue'));
	//alert(ndate);
	var weight=$.trim( $("#news_weight").val() );
	var content=ue.getContent();
	
	$.ajaxFileUpload({
		url:"../../newsServlet?op=addNewsInfo",
		secureuri:false,
		fileElementId:"news_pics",
		dataType:"json",
		data:{tid:tid,title:title,author:author,ndate:ndate,weight:weight,content:content},
		success:function(data,status){
			if(data>0){
				$.messager.show({title:'成功提示',msg:"新闻信息添加成功...",timeout:2000,showType:'slide'});
				$("#news_newstype").val("");
				$("#news_title").val("");
				$("#news_author").val("");
				$("#news_ndate").datebox('setValue',"");
				$("#news_weight").val("0");
				ue.setContent("");
				$("#news_pic_show").html("");
				$('#news_data').datagrid("reload");
				$('#add_news').dialog('close');  
			}else{
				$.messager.alert("错误提示","新闻信息添加失败...\n","error");
			}
		},
		error:function(data,status,e){
			$.messager.alert("错误提示","新闻信息添加失败...\n"+e,"error");
		}
	});
}

function searchSubmit(){
	//currentOp='findNewsBySearch';
	$("#mul_search").dialog("close");
	
	var newsType=$.trim($("#newsType").val());
	var newsTitle=$.trim($("#newsTitle").val());
	var newsStart=$.trim( $("#newsStart").datebox('getValue'));
	var newsEnd=$.trim( $("#newsEnd").datebox('getValue'));
	
	obj.datagrid('load',{//载入并显示第一页的记录，如果传递了'param'参数，它将会覆盖查询参数属性的值。通过传递一些参数，通常做一个查询，这个方法可以被称为从服务器加载新数据。
		op:'findNewsBySearch',
		'newsType': newsType,
		'newsTitle':newsTitle,
		'newsStart':newsStart,
		'newsEnd':newsEnd
	});
}

function up(nid,index){
	index--;
	var row = $($('#news_data').datagrid('getData').rows[index]);
	//alert(row.attr("nid"));
	if(row.attr("weight")==undefined){
		//表示要修改的这个是第一个了，所以 不操作
		return;
	}else{
		//表示修改的是后来的，
		//alert(row.attr("nid"));
		var weight=row.attr("weight");//这里拿到的weight是上一行的weight
		$.ajax({
			url:'../../newsServlet',
			data:{'op':'weightUp','nid':nid,'weight':weight+1},
			dataType:'JSON',
			type:'POST',
			success:function(data){//data=1  || 0
				if(data==1){
					$("#news_data").datagrid("reload");//重新加载
				}
			}
		});
	}
}
function down (nid,index){
	index++;
	var row = $($('#news_data').datagrid('getData').rows[index]);
	//alert(row.attr("nid"));
	if(row.attr("weight")==undefined){
		//表示要修改的这个是最后一个了，所以 不操作
		return;
	}else{
		//表示修改的是后来的，
		//alert(row.attr("nid"));
		var weight=row.attr("weight");
		$.ajax({
			url:'../../newsServlet',
			data:{'op':'weightDown','nid':nid,'weight':weight-1},
			dataType:'JSON',
			type:'POST',
			success:function(data){
				if(data==1){
					$("#news_data").datagrid("reload");
				}
			}
		});
	}
}
function toTop(nid,index){
	var row = $($('#news_data').datagrid('getData').rows[0]);
	if(index==0){
		//说明是第一行，不进行操作
		return;
	}else{
		var weight=row.attr("weight");
		$.ajax({
			url:'../../newsServlet',
			data:{'op':'weightTop','nid':nid,'weight':weight+1},
			type:'POST',
			dataType:'JSON',
			success:function(data){
				if(data==1){
					$("#news_data").datagrid("reload");
				}
			}
		});
	}
}

function showInfo(num){
	//alert(num);
	//window.location="../../newsServlet?op=showNews&nid="+num;
	window.open("../../newsServlet?op=showNews&nid="+num);
}

</script>
